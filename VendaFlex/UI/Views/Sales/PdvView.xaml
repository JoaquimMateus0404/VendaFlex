<Page x:Class="VendaFlex.UI.Views.Sales.PdvView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      mc:Ignorable="d"
      d:DesignHeight="908.403" d:DesignWidth="1625.27">

    <!-- Play entrance animation from GlobalStyles -->

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Global styles merged so the page recognizes styles defined in Styles/GlobalStyles.xaml -->
                <ResourceDictionary Source="/Styles/GlobalStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

        </ResourceDictionary>

    </Page.Resources>
    <Page.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource CardEntrance}"/>
        </EventTrigger>
    </Page.Triggers>

    <Grid Background="{StaticResource BackgroundBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3.5*"/>
            <ColumnDefinition Width="20"/>
            <ColumnDefinition Width="2.5*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- HEADER -->
        <Border Grid.Row="0" Grid.ColumnSpan="3"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource DividerBrush}"
                BorderThickness="0,0,0,1"
                Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Vertical">
                    <TextBlock Text="Ponto de Venda" Style="{StaticResource SectionTitle}"/>
                    <TextBlock Text="Sistema integrado para gerenciamento de vendas em tempo real"
                               Foreground="{StaticResource TextSecondaryBrush}" FontSize="13"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" >
                    <Border Background="{StaticResource WarningBrush}" Opacity="0.15" Padding="10,6" CornerRadius="6" Margin="0,0,6,0">
                        <StackPanel Orientation="Horizontal" >
                            <materialDesign:PackIcon Kind="Clock" Width="16" Height="16"
                                                     Foreground="{StaticResource WarningBrush}"/>
                            <TextBlock Text="Horario de Funcionamento" FontSize="11"
                                       Foreground="{StaticResource WarningBrush}"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </Border>

        <!-- CONTENT -->
        <ScrollViewer Grid.Row="1" Grid.ColumnSpan="3" VerticalScrollBarVisibility="Auto">
            <Grid Margin="24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3.5*"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="2.5*"/>
                </Grid.ColumnDefinitions>

                <!-- LEFT: Add + Items -->
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <!-- Add Product -->
                    <Border Style="{StaticResource GlassCard}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Adicionar Produtos" Foreground="{StaticResource TextPrimaryBrush}" FontSize="16" FontWeight="Bold"/>
                            <Grid Margin="0,16,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="160"/>
                                </Grid.ColumnDefinitions>

                                <TextBox Grid.Column="0" Style="{StaticResource ModernTextBox}"
                                         Tag="Código de Barras / SKU / Código"
                                         Text="{Binding ProductSearchTerm, UpdateSourceTrigger=PropertyChanged}"/>

                                <Button Grid.Column="1" Style="{StaticResource PrimaryButton}"
                                        Command="{Binding AddProductByCodeCommand}">
                                    <StackPanel Orientation="Horizontal" >
                                        <materialDesign:PackIcon Kind="Plus" Width="18" Height="18"/>
                                        <TextBlock Text="Adicionar" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Button>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Items -->
                    <Border Style="{StaticResource GlassCard}" Margin="0,0,0,20">
                        <StackPanel>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Itens do Carrinho" Foreground="{StaticResource TextPrimaryBrush}" FontSize="16" FontWeight="Bold"/>
                                <TextBlock Grid.Column="1" Text="{Binding CartItems.Count, StringFormat=Total: {0}}"
                                           Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                            </Grid>

                            <DataGrid ItemsSource="{Binding CartItems}"
                                      AutoGenerateColumns="False"
                                      HeadersVisibility="Column"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      SelectionMode="Single"
                                      RowHeaderWidth="0"
                                      GridLinesVisibility="None"
                                      Background="{StaticResource SurfaceBrush}"
                                      Foreground="{StaticResource TextPrimaryBrush}"
                                      BorderBrush="{StaticResource DividerBrush}"
                                      BorderThickness="1"
                                      Height="380">
                                <DataGrid.ColumnHeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="Background" Value="{StaticResource SurfaceVariantBrush}"/>
                                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                        <Setter Property="FontSize" Value="12"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="Padding" Value="8,6"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource DividerBrush}"/>
                                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                    </Style>
                                </DataGrid.ColumnHeaderStyle>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Setter Property="Height" Value="44"/>
                                        <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource DividerBrush}"/>
                                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                    </Style>
                                </DataGrid.RowStyle>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Código" Binding="{Binding ProductCode}" Width="120" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Produto" Binding="{Binding Name}" Width="*" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Qtd" Binding="{Binding Quantity}" Width="60"/>
                                    <DataGridTextColumn Header="Preço Unit." Binding="{Binding UnitPrice, StringFormat={}{0:N2}}" Width="100"/>
                                    <DataGridTextColumn Header="Desconto" Binding="{Binding Discount, StringFormat={}{0:N2}}" Width="90"/>
                                    <DataGridTextColumn Header="Total" Binding="{Binding LineTotal, StringFormat={}{0:N2}}" Width="120" IsReadOnly="True"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <Button Style="{StaticResource SecondaryButton}" Width="160"
                                        Command="{Binding ClearCartCommand}">
                                    <StackPanel Orientation="Horizontal" >
                                        <materialDesign:PackIcon Kind="Delete" Width="16" Height="16"/>
                                        <TextBlock Text="Limpar" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- DIVIDER -->
                <Border Grid.Column="1" Background="{StaticResource DividerBrush}" Width="1"/>

                <!-- RIGHT: Summary & Payment -->
                <StackPanel x:Name="RightPanel" Grid.Column="2" Orientation="Vertical">
                    <StackPanel.RenderTransform>
                        <TranslateTransform x:Name="RightPanelTransform" X="0"/>
                    </StackPanel.RenderTransform>

                    <!-- Summary -->
                    <Border Style="{StaticResource GlassCard}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Resumo do Pedido" Foreground="{StaticResource TextPrimaryBrush}" FontSize="16" FontWeight="Bold"/>
                            <StackPanel Margin="0,12,0,0">
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Subtotal" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding SubTotal, StringFormat={}{0:N2}}" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>

                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Descontos" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="-" Foreground="{StaticResource ErrorBrush}"/>
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource ErrorBrush}" Margin="6,0,0,0"/>
                                        <TextBlock Text="{Binding DiscountTotal, StringFormat={}{0:N2}}" Foreground="{StaticResource ErrorBrush}" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>

                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Impostos" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding TaxTotal, StringFormat={}{0:N2}}" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>

                                <Border Background="{StaticResource SurfaceVariantBrush}" CornerRadius="10" Padding="12">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Total" FontSize="14" FontWeight="Bold"/>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                            <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource PrimaryLightBrush}" FontSize="16" FontWeight="Bold"/>
                                            <TextBlock Text="{Binding GrandTotal, StringFormat={}{0:N2}}" Foreground="{StaticResource PrimaryLightBrush}" FontSize="18" FontWeight="Bold" Margin="6,0,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Payment -->
                    <Border Style="{StaticResource GlassCard}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Pagamento" Foreground="{StaticResource TextPrimaryBrush}" FontSize="16" FontWeight="Bold"/>

                            <StackPanel Margin="0,12,0,0">
                                <TextBlock Text="Forma" Style="{StaticResource ModernLabel}"/>
                                <ComboBox Style="{StaticResource ModernComboBox}"
                                          ItemsSource="{Binding PaymentTypes}"
                                          SelectedItem="{Binding SelectedPaymentType}"
                                          DisplayMemberPath="Name"/>

                                <TextBlock Text="Valor" Style="{StaticResource ModernLabel}"/>
                                <TextBox Style="{StaticResource ModernTextBox}"
                                         Tag="0,00"
                                         Text="{Binding PaymentAmount, UpdateSourceTrigger=PropertyChanged}"/>

                                <Button Style="{StaticResource PrimaryButton}"
                                        Command="{Binding AddPaymentCommand}">
                                    <StackPanel Orientation="Horizontal" >
                                        <materialDesign:PackIcon Kind="Check" Width="16" Height="16"/>
                                        <TextBlock Text="Adicionar Pagamento" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <StackPanel Margin="0,12,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Valor Pago" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding AmountPaid, StringFormat={}{0:N2}}" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Em Falta" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource WarningBrush}"/>
                                        <TextBlock Text="{Binding RemainingAmount, StringFormat={}{0:N2}}" Foreground="{StaticResource WarningBrush}" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Troco" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="{Binding CurrencySymbol}" Foreground="{StaticResource SuccessBrush}"/>
                                        <TextBlock Text="{Binding ChangeDue, StringFormat={}{0:N2}}" Foreground="{StaticResource SuccessBrush}" FontWeight="SemiBold" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Actions -->
                    <StackPanel Orientation="Vertical">
                        <Button Style="{StaticResource PrimaryButton}" Command="{Binding FinalizeSaleCommand}">
                            <StackPanel Orientation="Horizontal" >
                                <materialDesign:PackIcon Kind="CheckCircle" Width="18" Height="18"/>
                                <TextBlock Text="Finalizar Venda" Margin="6,0,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </ScrollViewer>

        <!-- FOOTER -->
        <Border Grid.Row="2" Grid.ColumnSpan="3" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource DividerBrush}" BorderThickness="0,1,0,0" Padding="24,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="VendaFlex" Foreground="{StaticResource TextTertiaryBrush}" FontSize="11"/>
                    <TextBlock Text="© 2025" Foreground="{StaticResource TextTertiaryBrush}" FontSize="11" Margin="16,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>